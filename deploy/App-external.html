<!DOCTYPE html>
<html>
<head>
    <title>Compare Plan Vs Actual</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){var e=this.getContext().getProject().ObjectID;console.log("Project:",e);var t=Ext.create("Rally.ui.combobox.ReleaseComboBox",{itemId:"releaseComboBox",multiSelect:!0,listeners:{select:function(t,a){console.log("combo:",t),console.log("records ",a);var r=[];if(a){for(var o=a.length-1;o>=0;o--)r.push(a[o].get("Name"));this._doSearch(null,null,e,r)}},ready:function(t){console.log("combo:",t),console.log("this:",this);var a=[];a.push(t.valueModels[0].get("Name")),this._doSearch(null,null,e,a)},scope:this}}),a=Ext.create("Ext.panel.Panel",{layout:"hbox",align:"stretch",padding:5,itemId:"datePanel",items:[{xtype:"panel",flex:1,itemId:"filterPanel"}]}),r=Ext.create("Ext.panel.Panel",{title:"Releases Plan VS Actual",layout:{type:"vbox",align:"stretch",padding:5},padding:5,itemId:"mainPanel"});this.myMask=new Ext.LoadMask({msg:"Please wait...",target:r}),this.add(a),a.down("#filterPanel").add(t),this.add(r)},_doSearch:function(e,t,a,r){console.log(r),this.myMask.show(),Ext.create("Rally.data.wsapi.Store",{model:"Project",autoLoad:!0,context:{projectScopeUp:!1,projectScopeDown:!0,project:null},filters:Rally.data.QueryFilter.or([{property:"parent.ObjectID",value:a},{property:"parent.parent.ObjectID",value:a}]),sorters:[{property:"Name",direction:"ASC"}],fetch:["Description","Name","ObjectID","Children","Releases","Iterations"],limit:1/0,listeners:{load:function(a,o,l){if(console.log("Data:",o),o&&0!=o.length){var n=[],s=["releaseName","iterationName"],i=[];_.each(o,function(a){if(0==a.get("Children").Count){var o=a.get("ObjectID"),l=a.get("Name"),c={id:o,name:l=(l=(l=(l=(l=l.replace(/\(/g,"")).replace(/\)/g,"")).replace(/\[/g,"")).replace(/\]/g,"")).replace(/\./g,""),releases:[]};n.push({xtype:"gridcolumn",dataIndex:l,text:l,columns:[{text:"Plan",dataIndex:"plan-"+o},{text:"Actual",dataIndex:"actual-"+o},{text:"Throughput",dataIndex:"throughtput-"+o,renderer:function(e,t){return parseInt(e)>=100?t.style="background-color:#cdf9c2; color: #090":t.style="background-color:#ffe2e2; color: #900",e}}]}),s.push(l),s.push("plan-"+o),s.push("actual-"+o),s.push("throughtput-"+o);var p=this._createReleasesFilter(r),d=Ext.create("Rally.data.WsapiDataStore",{model:"Release",context:{projectScopeUp:!1,projectScopeDown:!0,project:"/project/"+o},fetch:["Name","ObjectID","Project","ReleaseStartDate","ReleaseDate","PlanEstimate"],limit:1/0,filters:p}),u=Ext.create("Deft.Deferred");i.push(u),this._loadReleases(c,d,e,t).then({success:function(e){u.resolve(e)},failure:function(e){u.reject("error loading project")}})}},this),Deft.Promise.all(i).then({success:function(e){console.log("all projects:",i);var t=this._createReportRows(i);this.down("#mainPanel").removeAll(!0),t.eachKey(function(e,t){var a=[{xtype:"gridcolumn",dataIndex:"iterationName",text:"Iteration",width:150}];a.push.apply(a,n);var r=[];t.eachKey(function(e,t){r.push(t)});var o=Ext.create("Ext.grid.Panel",{columns:a,flex:1,title:"Release: "+e,store:{fields:s,data:r}});this.down("#mainPanel").add(o)},this),this.myMask.hide()},failure:function(e){console.log("error:",e)},scope:this})}else{var c=Ext.create("Ext.panel.Panel",{flex:1,title:"No child team found. This report should run on top level teams"});this.down("#mainPanel").removeAll(),this.down("#mainPanel").add(c),this.myMask.hide()}},scope:this}})},_createReleasesFilter:function(e){var t=void 0;if(1==e.length)t={property:"Name",operator:"=",value:e[0]};else if(2==e.length)t=Rally.data.wsapi.Filter.or([{property:"Name",operator:"=",value:e[0]},{property:"Name",operator:"=",value:e[1]}]);else if(e.length>2)for(var a of(t=Rally.data.wsapi.Filter.or([{property:"Name",operator:"=",value:e[0]},{property:"Name",operator:"=",value:e[1]}]),e=_.last(e,e.length-2)))t=Rally.data.wsapi.Filter.or([t,{property:"Name",operator:"=",value:a}]);return t},_createReportRows:function(e){console.log("creating rows");var t=new Ext.util.MixedCollection;return Ext.Array.each(e,function(e){var a=e.value.id;e.value.name;Ext.Array.each(e.value.releases,function(e){e.id;var r=e.name;e.startDate,e.endDate;Ext.Array.each(e.iterations,function(e){var o,l=e.id,n=e.name,s=(e.startDate,e.endDate,e.plan),i=e.actual,c=Math.round(i/s*100),p={iterationId:l,iterationName:n,releaseName:r};if(t.containsKey(r))if((o=t.get(r)).containsKey(n)){var d=o.get(n);d["plan-"+a]=s,d["actual-"+a]=i,d["throughtput-"+a]=c}else p["plan-"+a]=s,p["actual-"+a]=i,p["throughtput-"+a]=c,o.add(n,p);else o=new Ext.util.MixedCollection,p["plan-"+a]=s,p["actual-"+a]=i,p["throughtput-"+a]=c,o.add(n,p),t.add(r,o)})})},this),t},_loadReleases:function(e,t,a,r){var o=Ext.create("Deft.Deferred"),l=e.id,n=Ext.create("Rally.data.QueryFilter",{property:"project.ObjectID",value:l,operator:"="});return t.load().then({success:function(t,a,r){var l=[];console.log("loading releases",t),Ext.Array.each(t,function(t){var a=Ext.create("Rally.data.QueryFilter",{property:"StartDate",value:t.get("ReleaseStartDate"),operator:">="}),r=Ext.create("Rally.data.QueryFilter",{property:"EndDate",value:t.get("ReleaseDate"),operator:"<="}),o=a.and(r).and(n),s={id:t.get("ObjectID"),name:t.get("Name"),startDate:t.get("ReleaseStartDate"),endDate:t.get("ReleaseDate"),iterations:[]};e.releases.push(s),l.push(this._loadIterations(s,o))},this),0==t.length?o.resolve(e):Deft.Promise.all(l).then({success:function(t){console.log("releases results:",t),o.resolve(e)},failure:function(e){console.log("error:",e),o.reject("error loading release")}})},scope:this}),o.promise},_loadIterations:function(e,t){console.log("loading iterations for release",e);var a=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:"Iteration",fetch:["ObjectID","Name","StartDate","EndDate","PlannedVelocity","PlanEstimate"],context:{projectScopeUp:!1,projectScopeDown:!0,project:null},autoLoad:!0,filters:t,limit:1/0,sorters:[{property:"StartDate",direction:"ASC"}],listeners:{load:function(t,r,o){_.each(r,function(t){var a={id:t.get("ObjectID"),name:t.get("Name"),startDate:t.get("StartDate"),endDate:t.get("EndDate"),plan:t.get("PlannedVelocity"),actual:t.get("PlanEstimate")};e.iterations.push(a)}),a.resolve(e)}}}),a.promise}});

            Rally.launchApp('CustomApp', {
                name:"Compare Plan Vs Actual",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
