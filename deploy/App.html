<!DOCTYPE html>
<html>
<head>
    <title>Compare Plan Vs Actual</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){var e=this.getContext().getProject().ObjectID,t="",a="";console.log("Project:",e);var r=Ext.create("Ext.form.field.Date",{fieldLabel:"From:",listeners:{select:function(e,a){t=a.toISOString()}}}),n=Ext.create("Ext.form.field.Date",{fieldLabel:"To:",listeners:{select:function(e,t){a=t.toISOString()}}}),l=Ext.create("Rally.ui.Button",{text:"Search",margin:"10 10 10 100",scope:this,handler:function(){this._doSearch(t,a,e)}}),o=Ext.create("Ext.panel.Panel",{layout:"hbox",align:"stretch",padding:5,itemId:"datePanel",items:[{xtype:"panel",flex:1,itemId:"filterPanel"}]}),i=Ext.create("Ext.panel.Panel",{title:"Releases Plan VS Actual",layout:{type:"vbox",align:"stretch",padding:5},padding:5,itemId:"mainPanel"});this.myMask=new Ext.LoadMask({msg:"Please wait...",target:i}),this.add(o),o.down("#filterPanel").add(r),o.down("#filterPanel").add(n),o.down("#filterPanel").add(l),this.add(i)},_doSearch:function(e,t,a){""!=e&&""!=t&&(this.myMask.show(),Ext.create("Rally.data.wsapi.Store",{model:"Project",autoLoad:!0,context:{projectScopeUp:!1,projectScopeDown:!0,project:null},filters:Rally.data.QueryFilter.or([{property:"parent.ObjectID",value:a},{property:"parent.parent.ObjectID",value:a}]),sorters:[{property:"Name",direction:"ASC"}],fetch:["Description","Name","ObjectID","Children","Releases","Iterations"],listeners:{load:function(a,r,n){var l=[],o=["releaseName","iterationName"],i=[];_.each(r,function(a){if(0==a.get("Children").Count){var r=a.get("ObjectID"),n=a.get("Name"),s={id:r,name:n,releases:[]};l.push({xtype:"gridcolumn",dataIndex:n,text:n,columns:[{text:"Plan",dataIndex:"plan-"+r},{text:"Actual",dataIndex:"actual-"+r}]}),o.push(n),o.push("plan-"+r),o.push("actual-"+r);var c=a.getCollection("Releases",{fetch:["Name","ObjectID","Project","ReleaseStartDate","ReleaseDate","PlanEstimate"],filters:Rally.data.QueryFilter.and([{property:"StartDate",operator:">=",value:e},{property:"ReleaseDate",operator:"<=",value:t}])});if(c.initialCount>0){var d=Ext.create("Deft.Deferred");i.push(d),this._loadReleases(s,c,e,t).then({success:function(e){d.resolve(e)},failure:function(e){console.log("error:",e),d.reject("error loading project")}})}}},this),Deft.Promise.all(i).then({success:function(e){var t=this._createReportRows(i);this.down("#mainPanel").removeAll(!0),t.eachKey(function(e,t){var a=[{xtype:"gridcolumn",dataIndex:"iterationName",text:"Iteration",width:150}];a.push.apply(a,l);var r=[];t.eachKey(function(e,t){r.push(t)});var n=Ext.create("Ext.grid.Panel",{columns:a,flex:1,title:"Release: "+e,store:{fields:o,data:r}});this.down("#mainPanel").add(n)},this),this.myMask.hide()},failure:function(e){console.log("error:",e)},scope:this})},scope:this}}))},_createReportRows:function(e){var t=new Ext.util.MixedCollection;return Ext.Array.each(e,function(e){var a=e.value.id;e.value.name;Ext.Array.each(e.value.releases,function(e){e.id;var r=e.name;e.startDate,e.endDate;Ext.Array.each(e.iterations,function(e){var n,l=e.id,o=e.name,i=(e.startDate,e.endDate,e.plan),s=e.actual,c={iterationId:l,iterationName:o,releaseName:r};if(t.containsKey(r))if((n=t.get(r)).containsKey(o)){var d=n.get(o);d["plan-"+a]=i,d["actual-"+a]=s}else c["plan-"+a]=i,c["actual-"+a]=s,n.add(o,c);else n=new Ext.util.MixedCollection,c["plan-"+a]=i,c["actual-"+a]=s,n.add(o,c),t.add(r,n)})})},this),t},_loadReleases:function(e,t,a,r){var n=Ext.create("Deft.Deferred"),l=e.id,o=Ext.create("Rally.data.QueryFilter",{property:"project.ObjectID",value:l,operator:"="});return t.load({callback:function(t,a,r){var l=[];Ext.Array.each(t,function(t){var a=Ext.create("Rally.data.QueryFilter",{property:"StartDate",value:t.get("ReleaseStartDate"),operator:">="}),r=Ext.create("Rally.data.QueryFilter",{property:"EndDate",value:t.get("ReleaseDate"),operator:"<="}),n=a.and(r).and(o),i={id:t.get("ObjectID"),name:t.get("Name"),startDate:t.get("ReleaseStartDate"),endDate:t.get("ReleaseDate"),iterations:[]};e.releases.push(i),l.push(this._loadIterations(i,n))},this),0==t.length?n.resolve(e):Deft.Promise.all(l).then({success:function(t){n.resolve(e)},failure:function(e){console.log("error:",e),n.reject("error loading release")}})},scope:this}),n.promise},_loadIterations:function(e,t){var a=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:"Iteration",fetch:!0,autoLoad:!0,filters:t,sorters:[{property:"StartDate",direction:"ASC"}],listeners:{load:function(t,r,n){_.each(r,function(t){var a={id:t.get("ObjectID"),name:t.get("Name"),startDate:t.get("StartDate"),endDate:t.get("EndDate"),plan:t.get("PlannedVelocity"),actual:t.get("PlanEstimate")};e.iterations.push(a)}),a.resolve(e)}}}),a.promise}});

            Rally.launchApp('CustomApp', {
                name:"Compare Plan Vs Actual",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
